<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Rally Sync Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #050910;
      color: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 24px auto 40px;
      padding: 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 22px;
      font-size: 1.8rem;
      letter-spacing: 0.15em;
    }
    .card {
      background: #111827;
      border-radius: 12px;
      padding: 16px 20px 20px;
      margin-bottom: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid #1f2937;
    }
    .card h2 { margin: 0; font-size: 1.2rem; }
    .section-title {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }
    .section-title .index {
      font-size: 1.2rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .mode-badges {
      display: inline-flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #9ca3af;
    }
    .badge.active {
      background: #2563eb;
      border-color: #3b82f6;
      color: #e5f0ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    thead { background: #020617; }
    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #1f2937;
      font-size: 0.9rem;
    }
    th { font-weight: 500; color: #9ca3af; }
    tbody tr:hover { background: rgba(37, 99, 235, 0.08); }
    input[type="text"],
    input[type="number"],
    input[type="password"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.05s ease, box-shadow 0.1s ease, background 0.1s ease;
      white-space: nowrap;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.4) inset;
    }
    .btn-primary {
      background: #2563eb;
      color: #e5f0ff;
      box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-sm { padding: 6px 10px; font-size: 0.8rem; }

    .add-row-wrapper { margin-top: 10px; display: flex; justify-content: flex-start; }

    .rally-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      cursor: pointer;
      min-width: 38px;
    }
    .rally-btn.active {
      background: #2563eb;
      border-color: #3b82f6;
      color: #e5f0ff;
    }

    .time-inputs {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .time-inputs .time-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .time-inputs .time-box label {
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      width: 100%;
    }
    .time-inputs input { width: 80px; text-align: center; }

    .now-time {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
      color: #cbd5e1;
      font-size: 0.92rem;
      line-height: 1.45rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .now-time .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      white-space: nowrap;
    }
    .now-time .label { color: #9ca3af; }
    .now-time .value {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #e5e7eb;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      margin-bottom: 6px;
    }
    .result-box {
      margin-top: 2px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #1f2937;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.1rem;
      line-height: 1.55rem;
      white-space: pre-line;
      max-height: 220px;
      overflow-y: auto;
    }
    .footer-note {
      margin-top: 4px;
      margin-right: 6px;
      font-size: 0.95rem;
      line-height: 1.45rem;
      color: #6b7280;
      text-align: right;
    }

    .march-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .march-input { max-width: 80px; text-align: center; }
    .btn-march {
      padding: 2px 8px;
      font-size: 0.75rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }
    .btn-march:hover { background: #1f2937; }
    .march-hint {
      margin-top: 3px;
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
      min-height: 16px;
    }

    .top-actions {
      position: fixed;
      right: 16px;
      top: 14px;
      z-index: 50;
      display: none;
      gap: 8px;
    }

    .lock-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(1200px 600px at 50% 10%, rgba(37,99,235,0.18), transparent 60%),
                  rgba(0,0,0,0.72);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 100;
    }
    .lock-card {
      width: min(620px, 100%);
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      padding: 18px 18px 16px;
    }
    .lock-title {
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      margin: 0 0 6px 0;
      color: #e5e7eb;
      text-align: center;
    }
    .lock-desc {
      margin: 0 0 14px 0;
      color: #9ca3af;
      font-size: 0.92rem;
      line-height: 1.35rem;
      text-align: center;
    }
    .lock-row { display: flex; gap: 10px; align-items: center; }
    .lock-error {
      margin-top: 10px;
      color: #fca5a5;
      font-size: 0.9rem;
      min-height: 18px;
      text-align: center;
      white-space: pre-line;
    }

    .setup-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #1f2937;
      display: none;
    }
    .setup-title {
      font-size: 0.95rem;
      font-weight: 650;
      color: #cbd5e1;
      margin-bottom: 8px;
      text-align: center;
    }
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }
    .setup-hint {
      margin-top: 8px;
      color: #9ca3af;
      font-size: 0.85rem;
      line-height: 1.3rem;
      text-align: center;
      white-space: pre-line;
    }

    .app-hidden { display: none; }

    @media (max-width: 640px) {
      .container { padding: 12px; }
      th, td { font-size: 0.8rem; padding: 6px 4px; }
      .time-inputs input { width: 60px; }
      h1 { font-size: 1.4rem; }
      .now-time .row { white-space: normal; }
      .lock-row { flex-direction: column; }
      .setup-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="top-actions" id="topActions">
  <button id="resetBtn" class="btn btn-outline btn-sm">âŸ² ì´ˆê¸°í™”</button>
  <button id="lockBtn" class="btn btn-outline btn-sm">ğŸ”’ ì ê¸ˆ</button>
</div>

<div class="lock-overlay" id="lockOverlay" style="display:none;">
  <div class="lock-card">
    <div class="lock-title">Rally Sync Manager</div>
    <p class="lock-desc">
      ë¹„ë°€ë²ˆí˜¸(ìµœì†Œ 6ìë¦¬)ë¥¼ ì…ë ¥í•˜ë©´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      íƒ­/ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ìë™ ì ê¸ˆ
    </p>

    <div class="lock-row">
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)" autocomplete="current-password">
      <button id="pwSubmit" class="btn btn-primary">ì—´ê¸°</button>
    </div>

    <div class="lock-error" id="pwError"></div>

    <!-- âœ… ìš´ì˜ ê¸°ë³¸: ìˆ¨ê¹€ / ì„¤ì • ëª¨ë“œì—ì„œë§Œ í‘œì‹œ -->
    <div class="setup-box" id="setupBox">
      <div class="setup-title">ì„¤ì • ëª¨ë“œ (ìš´ì˜ ì¤‘ì—ëŠ” ìˆ¨ê¹€)</div>

      <div class="setup-grid">
        <input id="setupKeyInput" type="password" placeholder="ì„¤ì • í‚¤ ì…ë ¥ (ê´€ë¦¬ììš©)" autocomplete="off">
        <button id="setupEnterBtn" class="btn btn-outline btn-sm" type="button">ì§„ì…</button>
      </div>

      <div class="setup-grid" style="margin-top:8px;">
        <input id="newPwInput" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ) ì…ë ¥" autocomplete="new-password">
        <button id="makeHashBtn" class="btn btn-outline btn-sm" type="button">í•´ì‹œ ìƒì„±</button>
      </div>

      <div class="setup-hint" id="setupHint">
        1) ì„¤ì • í‚¤ë¡œ ì§„ì… â†’ 2) ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ â†’ 3) í•´ì‹œ ìƒì„± í´ë¦­<br>
        4) ì•„ë˜ ì¶œë ¥ëœ í•´ì‹œë¥¼ PASSWORD_HASH_B64ì— ë¶™ì—¬ë„£ê³  ë°°í¬
      </div>
    </div>

    <div class="setup-hint" id="setupFooter">
      ì´ˆê¸°í™”: ìš°ì¸¡ ìƒë‹¨ âŸ² ì´ˆê¸°í™” ë˜ëŠ” íƒ­/ë¸Œë¼ìš°ì € ì¢…ë£Œ
    </div>
  </div>
</div>

<div class="container app-hidden" id="appRoot">
  <h1>Rally Sync Manager</h1>

  <div class="card">
    <div class="section-title">
      <span class="index">1.</span>
      <h2>ì§‘ê²° í¸ì„± ì„¤ì •</h2>
    </div>

    <div class="mode-badges">
      <span class="badge active">ì§‘ê²° ë„ì°© ê¸°ì¤€ (ìë™ ì²« ì§‘ê²°ì¥ ê³„ì‚°)</span>
    </div>

    <table>
      <thead>
      <tr>
        <th style="width: 26%;">ì´ë¦„</th>
        <th style="width: 24%;">ì§‘ê²°(ë¶„)</th>
        <th style="width: 20%;">í–‰êµ°(ì´ˆ)</th>
        <th style="width: 18%;">ì§€ì—°(ì´ˆ)</th>
        <th style="width: 12%;">ì‚­ì œ</th>
      </tr>
      </thead>
      <tbody id="troop-body"></tbody>
    </table>

    <div class="add-row-wrapper">
      <button id="addRowBtn" class="btn btn-primary btn-sm">ï¼‹ ì§‘ê²° ì¶”ê°€</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">
      <span class="index">2.</span>
      <h2>ë„ì°© ëª©í‘œ ì‹œê°</h2>
    </div>

    <div style="font-size:0.9rem; color:#9ca3af; margin-bottom:4px;">
      ëª¨ë“  ë¶€ëŒ€ê°€ ë„ì°©í•´ì•¼ í•˜ëŠ” ì‹œê°ì„ <b>24ì‹œê°„ í˜•ì‹</b>(HH:MM:SS)ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤.<br>
      ì˜ˆ: ìì • 00:00:00, ì˜¤í›„ 2ì‹œëŠ” 14:00:00
    </div>

    <div class="time-inputs">
      <div class="time-box">
        <label for="baseHour">ì‹œ (Hour)</label>
        <input type="number" id="baseHour" min="0" max="23" value="">
      </div>
      <div class="time-box">
        <label for="baseMinute">ë¶„ (Minute)</label>
        <input type="number" id="baseMinute" min="0" max="59" value="">
      </div>
      <div class="time-box">
        <label for="baseSecond">ì´ˆ (Second)</label>
        <input type="number" id="baseSecond" min="0" max="59" value="">
      </div>
    </div>

    <div class="now-time" id="nowTimeBox" aria-live="polite">
      <div class="row">
        <div class="label">í˜„ì¬ ì‹œê°„ (UTC)</div>
        <div class="value" id="nowUtc">--:--:--</div>
      </div>
      <div class="row">
        <div class="label">í˜„ì¬ ì‹œê°„ (KST, í•œêµ­)</div>
        <div class="value" id="nowKst">--:--:--</div>
      </div>
    </div>

    <div class="result-header">
      <div style="font-weight:500;">ê²°ê³¼</div>
      <div>
        <button id="copyBtn" class="btn btn-outline btn-sm">í…ìŠ¤íŠ¸ ë³µì‚¬</button>
      </div>
    </div>

    <div class="result-box" id="resultBox">
      ì§‘ê²°ì„ ì¶”ê°€í•˜ê³  ë„ì°© ëª©í‘œ ì‹œê°ì„ ì…ë ¥í•˜ë©´ ì—¬ê¸° ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.
    </div>

    <div class="footer-note">
      ì‹œì‘ = ëª©í‘œë„ì°© âˆ’ ì§‘ê²°(ë¶„) âˆ’ í–‰êµ°(ì´ˆ) + ì§€ì—°(ì´ˆ) / ë„ì°© = ëª©í‘œë„ì°© + ì§€ì—°(ì´ˆ)<br>
      ì²« ì§‘ê²° ìƒì„± ì‹œê° = ê°€ì¥ ë¹ ë¥¸ ì§‘ê²° ì‹œì‘ ì‹œê°<br>
      ìˆœë²ˆ ì•„ì´ì½˜: ğŸ”´1ìˆœìœ„ > ğŸŸ¡2ìˆœìœ„ > ğŸŸ¢3ìˆœìœ„ > ğŸ”µ4ìˆœìœ„ > ğŸŸ£5ìˆœìœ„ > ğŸŸ¤6ìˆœìœ„<br>
      (ë„ì°© ì‹œê°„ì´ ë¹ ë¥¼ìˆ˜ë¡ ì• ìˆœìœ„)
    </div>

    <div style="
      text-align:center;
      position:relative;
      top:70px;
      margin-bottom:2px;
      color:#cbd5e1;
      font-size:0.9rem;
      font-weight:500;
      line-height:1.2rem;
    ">
      Â© 2025 Created by ë°©ìš¸ Â· #1
    </div>
  </div>
</div>

<script>
/* =========================================================
   âœ… GitHub Pages(ì •ì )ì—ì„œ ê°€ëŠ¥í•œ ìµœëŒ€ì¹˜: session ì ê¸ˆ + PBKDF2 + ë°±ì˜¤í”„
   ========================================================= */

// âœ… ì„¤ì • í‚¤(ê´€ë¦¬ììš©) : ì´ ê°’ì€ ê¸¸ê³  ëœë¤í•˜ê²Œ ë°”ê¾¸ëŠ” ê²Œ ì¢‹ìŒ
const SETUP_KEY = "Dbsgml0827#"; // â† ë°˜ë“œì‹œ êµì²´ ê¶Œì¥

// âœ… PBKDF2 íŒŒë¼ë¯¸í„°
const PBKDF2_ITER = 200_000;
const PBKDF2_SALT_B64 = "UlNNX3YzX3NhbHRfXzE2Ynl0ZXM="; // "RSM_v3_salt__16bytes" base64

// âœ… ì—¬ê¸°ë§Œ êµì²´: ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ(base64, 32 bytes)
// ê¸°ë³¸ê°’ì€ ì˜ˆì‹œ(ë¬´ì˜ë¯¸) â€” ë°˜ë“œì‹œ ìƒˆë¡œ ìƒì„±í•´ì„œ êµì²´
const PASSWORD_HASH_B64 = "7JgQLT6xaX3+f36uK0F9fzr4RU6tnDdYAuFUXBwt4N0=";

const AUTH_KEY      = "rsm_auth_ok_v3";
const FAIL_COUNT_K  = "rsm_fail_count_v3";
const LOCK_UNTIL_K  = "rsm_lock_until_v3";

function nowMs(){ return Date.now(); }

function b64ToU8(b64){
  const bin = atob(b64);
  const out = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
  return out;
}
function u8ToB64(u8){
  let s = "";
  for (let i=0;i<u8.length;i++) s += String.fromCharCode(u8[i]);
  return btoa(s);
}
function ctEqualB64(a,b){
  if (a.length !== b.length) return false;
  let r = 0;
  for (let i=0;i<a.length;i++) r |= (a.charCodeAt(i) ^ b.charCodeAt(i));
  return r === 0;
}
async function pbkdf2HashB64(password){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    enc.encode(password),
    "PBKDF2",
    false,
    ["deriveBits"]
  );
  const salt = b64ToU8(PBKDF2_SALT_B64);
  const bits = await crypto.subtle.deriveBits(
    { name: "PBKDF2", salt, iterations: PBKDF2_ITER, hash: "SHA-256" },
    keyMaterial,
    256
  );
  return u8ToB64(new Uint8Array(bits));
}

function isAuthed(){ return sessionStorage.getItem(AUTH_KEY) === "1"; }
function setAuthed(ok){
  if (ok) sessionStorage.setItem(AUTH_KEY,"1");
  else sessionStorage.removeItem(AUTH_KEY);
}
function getFailCount(){ return parseInt(sessionStorage.getItem(FAIL_COUNT_K)||"0",10)||0; }
function setFailCount(n){ sessionStorage.setItem(FAIL_COUNT_K, String(Math.max(0, n|0))); }
function getLockUntil(){ return parseInt(sessionStorage.getItem(LOCK_UNTIL_K)||"0",10)||0; }
function setLockUntil(ts){ sessionStorage.setItem(LOCK_UNTIL_K, String(ts|0)); }

function resetSessionAll(){
  sessionStorage.removeItem(AUTH_KEY);
  sessionStorage.removeItem(FAIL_COUNT_K);
  sessionStorage.removeItem(LOCK_UNTIL_K);
}

function showApp(){
  document.getElementById("appRoot").classList.remove("app-hidden");
  document.getElementById("lockOverlay").style.display = "none";
  document.getElementById("topActions").style.display = "flex";
  updateNowTime();
  setInterval(updateNowTime, 1000);
}

function showLock(message){
  document.getElementById("appRoot").classList.add("app-hidden");
  document.getElementById("lockOverlay").style.display = "flex";
  document.getElementById("topActions").style.display = "none";
  const pw = document.getElementById("pwInput");
  const err = document.getElementById("pwError");
  if (pw) pw.value = "";
  if (err) err.textContent = message || "";
  if (pw) pw.focus();
  updateLockUI();
}

function updateLockUI(){
  const pw = document.getElementById("pwInput");
  const btn = document.getElementById("pwSubmit");
  const err = document.getElementById("pwError");

  const until = getLockUntil();
  const remain = until - nowMs();
  if (remain > 0){
    const sec = Math.ceil(remain/1000);
    if (pw) pw.disabled = true;
    if (btn) btn.disabled = true;
    if (err) err.textContent = `ì ê¸ˆ ìƒíƒœ: ${sec}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„`;
    return;
  }
  if (pw) pw.disabled = false;
  if (btn) btn.disabled = false;
}

function bumpLock(){
  const fc = getFailCount();
  const table = [0, 2, 5, 10, 20, 40, 60];
  const lockSec = table[Math.min(fc, table.length-1)];
  if (lockSec > 0) setLockUntil(nowMs() + lockSec*1000);
}

async function tryLogin(){
  updateLockUI();
  const until = getLockUntil();
  if (until - nowMs() > 0) return;

  const pw = (document.getElementById("pwInput").value || "").trim();
  const err = document.getElementById("pwError");

  if (pw.length < 6){
    if (err) err.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
    return;
  }

  const got = await pbkdf2HashB64(pw);
  if (ctEqualB64(got, PASSWORD_HASH_B64)) {
    setAuthed(true);
    setFailCount(0);
    setLockUntil(0);
    showApp();
    return;
  }

  setFailCount(getFailCount()+1);
  bumpLock();
  if (err) err.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  updateLockUI();
}

/* âœ… ì„¤ì • ëª¨ë“œ (Q3): ìš´ì˜ ê¸°ë³¸ì€ ìˆ¨ê¹€, ì„¤ì • í‚¤ë¥¼ ì•Œì•„ì•¼ë§Œ í•´ì‹œ ìƒì„± ê°€ëŠ¥ */
let setupUnlocked = false;

function openSetupBox(){
  document.getElementById("setupBox").style.display = "block";
}

function closeSetupBox(){
  document.getElementById("setupBox").style.display = "none";
  setupUnlocked = false;
  document.getElementById("setupKeyInput").value = "";
  document.getElementById("newPwInput").value = "";
}

function tryEnterSetup(){
  const k = (document.getElementById("setupKeyInput").value || "").trim();
  const hint = document.getElementById("setupHint");
  if (k === SETUP_KEY){
    setupUnlocked = true;
    if (hint) hint.textContent =
      "ì„¤ì • ëª¨ë“œ ì§„ì… ì™„ë£Œ.\nìƒˆ ë¹„ë°€ë²ˆí˜¸(6ìë¦¬ ì´ìƒ)ë¥¼ ì…ë ¥í•˜ê³  [í•´ì‹œ ìƒì„±]ì„ ëˆ„ë¥´ì„¸ìš”.\nìƒì„±ëœ í•´ì‹œë¥¼ PASSWORD_HASH_B64ì— ë¶™ì—¬ë„£ê³  ë‹¤ì‹œ ë°°í¬í•˜ë©´ ë³€ê²½ë©ë‹ˆë‹¤.";
    return;
  }
  if (hint) hint.textContent = "ì„¤ì • í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
}

async function makeHashForNewPassword(){
  const err = document.getElementById("pwError");
  const hint = document.getElementById("setupHint");
  if (!setupUnlocked){
    if (hint) hint.textContent = "ë¨¼ì € [ì§„ì…]ìœ¼ë¡œ ì„¤ì • ëª¨ë“œë¥¼ í•´ì œ(Unlock)í•˜ì„¸ìš”.";
    return;
  }
  const newPw = (document.getElementById("newPwInput").value || "").trim();
  if (newPw.length < 6){
    if (hint) hint.textContent = "ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
    return;
  }
  const h = await pbkdf2HashB64(newPw);
  if (err) err.textContent = `í•´ì‹œ ìƒì„± ì™„ë£Œ â†’ PASSWORD_HASH_B64ì— ë¶™ì—¬ë„£ê¸°:\n${h}`;
  if (hint) hint.textContent =
    "1) ìœ„ í•´ì‹œë¥¼ ë³µì‚¬\n2) ì½”ë“œì˜ PASSWORD_HASH_B64 ê°’ì„ êµì²´\n3) GitHubì— ì»¤ë°‹/ë°°í¬\n4) ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ì ‘ì†";
}

/* =========================
   ê¸°ì¡´ ê¸°ëŠ¥(ì‹œê°„/ê³„ì‚°)
   ========================= */
let lastCopyText = "";
function pad2(num){ return num.toString().padStart(2,"0"); }

function updateNowTime(){
  const utcEl = document.getElementById("nowUtc");
  const kstEl = document.getElementById("nowKst");
  if (!utcEl || !kstEl) return;

  const now = new Date();
  const utc = new Intl.DateTimeFormat("en-GB", {
    timeZone:"UTC", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false
  }).format(now);
  const kst = new Intl.DateTimeFormat("en-GB", {
    timeZone:"Asia/Seoul", hour:"2-digit", minute:"2-digit", second:"2-digit", hour12:false
  }).format(now);
  utcEl.textContent = utc;
  kstEl.textContent = kst;
}

function parseTimeInput(val){
  if (!val) return 0;
  val = String(val).trim();
  if (val.includes(":")){
    const parts = val.split(":");
    let m = parseInt(parts[0].replace(/\D/g,""),10);
    let s = parseInt((parts[1]||"0").replace(/\D/g,""),10);
    if (isNaN(m)) m=0; if (isNaN(s)) s=0;
    if (s>=60){ m += Math.floor(s/60); s = s%60; }
    return m*60 + s;
  }
  const n = parseInt(val.replace(/\D/g,""),10);
  return isNaN(n)?0:n;
}

function formatMMSS(sec){
  sec = Math.max(0, parseInt(sec,10)||0);
  const m = Math.floor(sec/60);
  const s = sec%60;
  if (m===0) return String(s);
  return m + ":" + pad2(s);
}

function formatTimeFromSeconds(totalSeconds){
  const secondsInDay = 24*3600;
  let sec = ((totalSeconds%secondsInDay)+secondsInDay)%secondsInDay;
  const h = Math.floor(sec/3600); sec%=3600;
  const m = Math.floor(sec/60);
  const s = sec%60;
  return pad2(h)+":"+pad2(m)+":"+pad2(s);
}

function getBaseSeconds(){
  const hRaw = document.getElementById("baseHour").value;
  const mRaw = document.getElementById("baseMinute").value;
  const sRaw = document.getElementById("baseSecond").value;
  if (hRaw==="" && mRaw==="" && sRaw==="") return null;
  const h = parseInt(hRaw,10)||0;
  const m = parseInt(mRaw,10)||0;
  const s = parseInt(sRaw,10)||0;
  const hh = Math.min(Math.max(h,0),23);
  const mm = Math.min(Math.max(m,0),59);
  const ss = Math.min(Math.max(s,0),59);
  return hh*3600 + mm*60 + ss;
}

function recalc(){
  const tbody = document.getElementById("troop-body");
  const rows = tbody.querySelectorAll("tr");
  const box = document.getElementById("resultBox");

  if (rows.length===0){
    box.textContent = "ì§‘ê²°ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.";
    lastCopyText = "";
    return;
  }
  const baseSeconds = getBaseSeconds();
  if (baseSeconds===null){
    box.textContent = "ë„ì°© ëª©í‘œ ì‹œê°ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    lastCopyText = "";
    return;
  }

  const items = [];
  rows.forEach(function(row,index){
    const nameInput = row.querySelector(".name");
    const marchInput = row.querySelector(".march");
    const delayInput = row.querySelector(".delay");
    const rallyToggle = row.querySelector(".rally-toggle");
    const marchHint = row.querySelector(".march-hint");

    const isNameEmpty = !nameInput.value.trim();
    const isMarchEmpty = !marchInput.value.trim();
    const isDelayEmpty = !delayInput.value.trim();
    if (isNameEmpty && isMarchEmpty && isDelayEmpty){
      if (marchHint) marchHint.textContent="";
      return;
    }

    const name = (nameInput.value||"").trim() || (index+1)+"ë²ˆ";

    let rallyMin = 0;
    if (rallyToggle){
      const activeBtn = rallyToggle.querySelector(".rally-btn.active");
      if (activeBtn) rallyMin = parseInt(activeBtn.dataset.value,10)||0;
    }

    const marchSec = parseTimeInput(marchInput.value);
    const delaySec = parseInt(delayInput.value,10)||0;

    if (marchHint){
      if (marchSec>0) marchHint.textContent = "í–‰êµ°: " + formatMMSS(marchSec) + " (" + marchSec + "ì´ˆ)";
      else marchHint.textContent = "";
    }

    const startSeconds = baseSeconds - rallyMin*60 - marchSec + delaySec;
    const arrivalSeconds = baseSeconds + delaySec;

    items.push({ name, rallyMin, startSeconds, arrivalSeconds });
  });

  if (items.length===0){
    box.textContent = "ì§‘ê²° ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
    lastCopyText = "";
    return;
  }

  let leader = items[0];
  items.forEach(it=>{ if (it.startSeconds < leader.startSeconds) leader = it; });

  const headerLine = "ğŸ”· ì²« ì§‘ê²° ìƒì„± ì‹œê°: " + formatTimeFromSeconds(leader.startSeconds) +
    " (ì²« ì§‘ê²°ì¥: " + leader.name + ")";

  const sortedItems = items.slice().sort((a,b)=>{
    if (a.arrivalSeconds !== b.arrivalSeconds) return a.arrivalSeconds - b.arrivalSeconds;
    return a.startSeconds - b.startSeconds;
  });

  const rankIcons = ["ğŸ”´","ğŸŸ¡","ğŸŸ¢","ğŸ”µ","ğŸŸ£","ğŸŸ¤"];
  const lines = sortedItems.map((it,idx)=>{
    const icon = rankIcons[idx] || "âšª";
    return icon + " " + it.name + ": ì§‘ê²° ì‹œì‘ " + formatTimeFromSeconds(it.startSeconds) +
      " | " + it.rallyMin + "ë¶„ ì§‘ê²°" +
      " | ì˜ˆìƒ ë„ì°© " + formatTimeFromSeconds(it.arrivalSeconds);
  });

  const fullText = headerLine + "\n" + lines.join("\n");
  box.textContent = fullText;
  lastCopyText = fullText;
}

function attachRowEvents(row){
  const nameInput = row.querySelector(".name");
  const marchInput = row.querySelector(".march");
  const delayInput = row.querySelector(".delay");
  const rallyButtons = row.querySelectorAll(".rally-btn");
  const adjustButtons = row.querySelectorAll(".btn-march");
  const marchHint = row.querySelector(".march-hint");

  [nameInput, delayInput].forEach(input=>{
    if (!input) return;
    input.addEventListener("input", recalc);
  });

  if (marchInput){
    marchInput.addEventListener("input", recalc);
    marchInput.addEventListener("blur", function(){
      const sec = parseTimeInput(marchInput.value);
      if (sec<=0){
        marchInput.value="";
        if (marchHint) marchHint.textContent="";
      } else {
        marchInput.value = formatMMSS(sec);
      }
      recalc();
    });
  }

  rallyButtons.forEach(btn=>{
    btn.addEventListener("click", function(){
      rallyButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      recalc();
    });
  });

  adjustButtons.forEach(btn=>{
    btn.addEventListener("click", function(){
      const delta = parseInt(btn.dataset.delta,10)||0;
      let sec = parseTimeInput(marchInput.value);
      sec = Math.max(0, sec + delta);
      if (sec===0){
        marchInput.value="";
        if (marchHint) marchHint.textContent="";
      } else {
        marchInput.value = formatMMSS(sec);
      }
      recalc();
    });
  });

  const delBtn = row.querySelector(".btn-delete");
  if (delBtn) delBtn.addEventListener("click", function(){ row.remove(); recalc(); });
}

function createRow(defaults, deletable=true){
  const tbody = document.getElementById("troop-body");
  const tr = document.createElement("tr");

  const d = Object.assign({ name:"", rally:5, march:"", delay:"" }, defaults||{});
  const rallyVal = parseInt(d.rally,10) || 5;

  const deleteCellHtml = deletable
    ? `<button type="button" class="btn btn-outline btn-sm btn-delete">Del</button>`
    : "";

  tr.innerHTML = `
    <td><input type="text" class="name" placeholder="ë‹‰ë„¤ì„" value="${d.name}"></td>
    <td>
      <div class="rally-toggle" style="display:flex; flex-direction:column; gap:4px;">
        <div style="display:flex; gap:4px; justify-content:center;">
          <button type="button" class="rally-btn ${rallyVal===1?"active":""}" data-value="1">1ë¶„</button>
          <button type="button" class="rally-btn ${rallyVal===3?"active":""}" data-value="3">3ë¶„</button>
          <button type="button" class="rally-btn ${rallyVal===5?"active":""}" data-value="5">5ë¶„</button>
        </div>
        <div style="display:flex; gap:4px; justify-content:center;">
          <button type="button" class="rally-btn ${rallyVal===15?"active":""}" data-value="15">15ë¶„</button>
          <button type="button" class="rally-btn ${rallyVal===30?"active":""}" data-value="30">30ë¶„</button>
          <button type="button" class="rally-btn ${rallyVal===60?"active":""}" data-value="60">60ë¶„</button>
        </div>
      </div>
    </td>
    <td>
      <div class="march-wrapper">
        <button type="button" class="btn-march" data-delta="-1">-1</button>
        <input type="text" class="march march-input" value="${d.march}" placeholder="ì˜ˆ: 1:30">
        <button type="button" class="btn-march" data-delta="1">+1</button>
      </div>
      <div class="march-hint"></div>
    </td>
    <td><input type="number" class="delay" min="0" step="1" value="${d.delay}"></td>
    <td>${deleteCellHtml}</td>
  `;

  tbody.appendChild(tr);
  attachRowEvents(tr);
}

document.addEventListener("DOMContentLoaded", function(){
  // ì ê¸ˆ ì²´í¬
  if (isAuthed()) showApp();
  else showLock();

  // ì ê¸ˆ ì´ë²¤íŠ¸
  document.getElementById("pwSubmit").addEventListener("click", tryLogin);
  document.getElementById("pwInput").addEventListener("keydown", (e)=>{ if (e.key==="Enter") tryLogin(); });

  document.getElementById("lockBtn").addEventListener("click", ()=>{
    resetSessionAll();
    showLock("ì ê¸ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  });

  // âœ… ì´ˆê¸°í™” ë²„íŠ¼: ì„¸ì…˜(ì¸ì¦/ì‹¤íŒ¨/ì ê¸ˆ) ì´ˆê¸°í™” + ì ê¸ˆ í™”ë©´ìœ¼ë¡œ
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    resetSessionAll();
    showLock("ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
  });

  // âœ… ì„¤ì • ëª¨ë“œ(Q3): Ctrl+Alt+Shift+S ëˆ„ë¥´ë©´ ì„¤ì • ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€ (ìš´ì˜ ì¤‘ì—” ì•ˆ ë³´ì„)
  document.addEventListener("keydown", (e)=>{
    if (e.ctrlKey && e.altKey && e.shiftKey && (e.key==="s" || e.key==="S")){
      const box = document.getElementById("setupBox");
      if (box.style.display === "block") closeSetupBox();
      else openSetupBox();
    }
  });

  document.getElementById("setupEnterBtn").addEventListener("click", tryEnterSetup);
  document.getElementById("makeHashBtn").addEventListener("click", makeHashForNewPassword);

  setInterval(updateLockUI, 250);

  // ì´ˆê¸° í–‰
  createRow({}, false);
  createRow({}, false);
  createRow({}, false);

  document.getElementById("addRowBtn").addEventListener("click", function(){
    createRow({}, true);
    recalc();
  });

  document.getElementById("baseHour").addEventListener("input", recalc);
  document.getElementById("baseMinute").addEventListener("input", recalc);
  document.getElementById("baseSecond").addEventListener("input", recalc);

  document.getElementById("copyBtn").addEventListener("click", function(){
    if (!lastCopyText) return;
    if (!navigator.clipboard) {
      alert("í´ë¦½ë³´ë“œ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì…ë‹ˆë‹¤.");
      return;
    }
    navigator.clipboard.writeText(lastCopyText);
  });
});
</script>
</body>
</html>
